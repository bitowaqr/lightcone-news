name: Deploy to EC2 (Build Artifact)

on:
  push:
    branches:
      - main # Or your deployment branch

jobs:
  build_and_deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest
    env:
      # Define Node version to use - ensure it's compatible with your project
      NODE_VERSION: '18' # Or '20' if you prefer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Optional: Cache npm dependencies for faster installs
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Build Nuxt application
        # Add environment variables needed for build if any
        # Example: env:
        #   NUXT_PUBLIC_API_BASE: ${{ secrets.API_BASE_URL }}
        run: npm run build

      - name: Archive build artifact
        run: tar -czf output.tar.gz .output

      - name: Copy artifact and config to EC2
        uses: appleboy/scp-action@v0.1.7 # Or a later compatible version
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "output.tar.gz,docker-compose.yml" # Add other files comma-separated if needed
          target: "/tmp/"
          strip_components: 1 # Optional: Adjust if needed

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- Main Deployment Script Starts Here ---
            set -e
            EC2_APP_PATH="/home/${{ secrets.SSH_USER }}/app"
            PM2_APP_NAME="lightcone"

            echo "Starting deployment steps on EC2..."
            cd $EC2_APP_PATH

            # Create or overwrite the .env file using the secret
            echo "Creating .env file from secrets..."
            printf '%s\n' "${{ secrets.DOT_ENV_PRODUCTION }}" > $EC2_APP_PATH/.env
            chmod 600 $EC2_APP_PATH/.env

            echo "Stopping PM2 application..."
            pm2 stop $PM2_APP_NAME || true

            echo "Removing old build artifact directory..."
            rm -rf .output

            echo "Extracting new build artifact from /tmp..."
            # Check if the artifact exists in /tmp (copied by scp-action)
            if [ -f /tmp/output.tar.gz ]; then
              # Create the target directory if it doesn't exist
              mkdir -p $EC2_APP_PATH/.output 
              # Extract the contents of the tarball INTO the .output directory
              tar -xzf /tmp/output.tar.gz -C $EC2_APP_PATH/.output --strip-components=1
              echo "Artifact extracted."
            else
              echo "ERROR: Build artifact /tmp/output.tar.gz not found! SCP step likely failed."
              exit 1
            fi

            echo "Updating docker-compose.yml (assuming it was copied to /tmp)..."
            if [ -f /tmp/docker-compose.yml ]; then
              cp /tmp/docker-compose.yml $EC2_APP_PATH/docker-compose.yml
              echo "docker-compose.yml updated."
            else
              echo "Warning: /tmp/docker-compose.yml not found, using existing."
            fi

            echo "Restarting Docker Compose services using created .env file..."
            docker-compose up -d --remove-orphans

            echo "Restarting PM2 application..."
            pm2 restart $PM2_APP_NAME

            echo "Cleaning up temporary files..."
            rm -f /tmp/output.tar.gz
            rm -f /tmp/docker-compose.yml

            echo "Deployment finished successfully on EC2." 